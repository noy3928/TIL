# 7.신뢰할 수 없는 코드를 쓰면서 불변성 지키기 

> - 레거시 코드나 신뢰할 수 없는 코드로부터 내 코드를 보호하기 위해 방어적 복사를 만든다. 
> - 얕은 복사와 깊은 복사를 비교한다. 
> - 카피-온-라이트와 방어적 복사를 언제 사용하면 좋은지 알 수 있다. 


레거시 코드가 존재한다고 가정해보자. 이 레거시 코드는 불변성을 고려하지 않고, 기존의 데이터를 변형시켜 버린다. 
```javascript 
function add_item_to_cart(name, price){
	...
	black_friday_promotion(shopping_cart) // -> 이 코드는 장바구니를 바꾼다. 
}
```

문제는 이 레거시 코드를 우리가 건드릴 수 없는 상황이라는 것이다. 이럴 때 어떻게하면 불변성을 지킬 수 있을까? 바로 이때 사용할 수 있는 방법이 바로 방어적 복사이다. 


## 방어적 복사는 원본이 바뀌는 것을 막아준다. 

방어적 복사는 함수에 인자를 넘기기 전에 해당 데이터를 복사한다. 그리고 복사한 데이터를 함수에 넣어준다. 그 다음 함수로부터 받아온 값을 다시 한번 복사하고, 복사한 그 값을 사용한다. 이렇게 함으로써 코드 전체에 퍼져나가는 예측 불가능성(기존 객체의 변형)을 막아버린다.

이것을 구현하는 방법은 아래와 같다. 
```javascript
function add_item_to_cart(name, price){
	...
	var cart_copy = deepCopy(shopping_cart)
	black_friday_promotion(shopping_cart) // -> 이 코드는 장바구니를 바꾼다. 
	shopping_cart = deepCopy(cart_copy)
}
```



## 방어적 복사를 위한 규칙 

### 규칙 1 : 데이터가 안전한 코드에서 나갈 때 복사하기 

1. 불변성 데이터를 위한 깊은 복사본을 만든다. 
2. 신뢰할 수 없는 코드로 복사본을 전달한다. 


### 규칙 2 : 안전한 코드로 데이터가 들어올 때 복사하기 

1. 변경될 수도 있는 데이터가 들어오면 바로 깊은 복사본을 만들어 안전한 코드로 전달한다. 
2. 복사본을 안전한 코드에서 사용한다. 



## 신뢰할 수 없는 코드를 감싸기 

위에서 방어적 코드를 통해서 복사본을 만들었지만, 추후에보면 왜 여기서 복사본을 만들었는지 이해하지 못할 수도 있다. 때문에, 이것을 함수로 분리해서 새롭게 만들어보자. 

```javascript 
...
shopping_cart = black_friday_promotion_safe(shopping_cart);
}

function black_friday_promotion_safe(cart){
	var cart_copy = deepCopy(cart);
	black_friday_promotion(cart_copy);
	return deepCopy(cart_copy);
}
```


##  방어적 복사를 사용하는 다른 예시 

### 웹 API 속의 방어적 복사 

JSON 데이터가 API에 요청으로 들어왔다고 해보자. 클라이언트는 데이터를 인터넷을 통해 API로 보내려고 직렬화 한다. 이때 JSON 데이터는 깊은 복사본이다. 서비스가 잘 동작한다면 JSON으로 응답한다. 이때 JSON도 역시 깊은 복사본이다. 서비스에 들어올 때와 나갈 때 데이터를 복사한 것이다. 


## 카피-온-라이트와 방어적 복사 비교 

| |카피-온-라이트 |방어적 복사 |
|---|-|-| 
|when |통제할 수 있는 데이터를 바꿀 때 카피-온-라이트를 사용한다.|신뢰할 수 없는 코드와 데이터를 주고받아야 할 때 방어적 복사를 사용한다|
|where|안전지대 어디서나 사용.|안전지대의 경계에서 데이터가 오갈 때|
|복사방식 |얕은 복사 | 깊은 복사|

