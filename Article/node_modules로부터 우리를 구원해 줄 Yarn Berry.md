[읽은 링크](https://toss.tech/article/node-modules-and-yarn-berry)

- yarn berry는 새로운 패키지 매니저다.
- 기존의 "깨져있는" NPM 패키지 관리 시스템을 혁신적으로 개선한다.

<br>

## NPM의 문제점 :

### 1.NPM의 비효율적인 의존성 검색

- NPM은 패키지를 찾기 위해서 계속 상위 디렉토리의 node_modules 폴더를 탐색한다.
- 따라서 패키지를 바로 찾지 못할수록 readdir, stat과 같은 느린 I/O 호출이 반복됩니다. 경우에 따라서는 I/O 호출이 중간에 실패하기도 한다.

<br>

### 2.환경에 따라 달라지는 동작

- NPM은 패키지를 찾지 못하면 상위 디렉토리의 node_modules 폴더를 계속 검색한다.
- 이 특성 때문에 어떤 의존성을 찾을 수 있는지는 해당 패키지의 상위 디렉토리 환경에 따라 달라집니다.
  - (상위 디렉토리 환경이 달라진다는 말이 정확하게 이해되지 않는다.)

예를 들어, 상위 디렉토리가 어떤 node_modules를 포함하고 있는지에 따라 의존성을 불러올 수 있기도 하고, 없기도 합니다. 다른 버전의 의존성을 잘못 불러올 수 있는 여지도 존재합니다.  
(어떤 node_modules라는 말은, node_modules도 종류가 달라질 수 있다는 말인가?)

- 이렇게 환경에 따라 동작이 변하는 것은 나쁜 징조입니다. 해당 상황을 재현하기 까다로워지기 때문입니다.

<br>

## 3.비효율적인 설치

- NPM에서 구성하는 node_modules 디렉토리 구조는 매우 큰 공간을 차지한다.
- 일반적으로 간단한 CLI 프로젝트도 수백 메가바이트의 node_modules 폴더가 필요하다.
- 용량만 많이 차지할 뿐 아니라, 큰 node_modules 디렉토리 구조를 만들기 위해서는 많은 I/O 작업이 필요하다.

- node_modules 폴더는 복잡하기 때문에 설치가 유효한지 검증하기 어렵다. 예를 들어, 수백 개의 패키지가 서로를 의존하는 복잡한 의존성 트리에서 node_modules 디렉토리 구조는 깊어진다.

이렇게 깊은 트리 구조에서 의존성이 잘 설치되어 있는지 검증하려면 많은 수의 I/O 호출이 필요하다. 일반적으로 디스크 I/O 호출은 메모리의 자료구조를 다루는 것보다 훨씬 느리다. 이런 문제로 인해 Yarn v1이나 NPM은 기본적인 의존성 트리의 유효성까지만 검증하고, 각 패키지의 내용이 올바른지는 확인하지 않는다.

<br>

## 4.유령 의존성

- 중복된 의존성이 있을 때, 합친다. 그러다보면 직접적으로 연결되지 않았던 의존성이 직접적인 연결이 생긴다.
- 그로 인해서 package.json에 명시되지 않았던 의존성을 사용할 수 있게 된다.
- 그리고 다른 의존성을 삭제했을 때, 조용히 같이 사라지기도 한다.
- 이런 구조는 혼란을 야기한다.

<br>

---

## Plug’n’Play (PnP)

- Yarn Berry는 위에서 언급한 문제를 새로운 Plug’n’Play 전략을 이용하여 해결한다.

### Plug’n’Play (PnP)의 배경

- 보다 근본적으로 안전하게 의존성을 관리할 수 있는 방법은 없을까? 그런 생각에서 출발했다.

### Plug’n’Play 켜기

```bash
$ npm install -g yarn
$ cd ../path/to/some-package
$ yarn set version berry
```

- 버전을 berry로 설정할 것.

### Plug’n’Play의 동작 방법

- yarn berry는 node_modules를 생성하지 않는다.
- 대신 .yarn/cache 폴더에 의존성의 정보가 저장된다.
- .pnp.cjs 파일에 의존성을 찾을 수 있는 정보가 기록된다.

예를 들어, 리액트 .pnp.cjs 파일에는 다음과 같은 정보가 있다.

```javascript
/* react 패키지 중에서 */
["react", [
  /* npm:17.0.1 버전은 */
  ["npm:17.0.1", {
    /* 이 위치에 있고 */
    "packageLocation": "./.yarn/cache/react-npm-17.0.1-98658812fc-a76d86ec97.zip/node_modules/react/",
    /* 이 의존성들을 참조한다. */
    "packageDependencies": [
      ["loose-envify", "npm:1.4.0"],
      ["object-assign", "npm:4.1.1"]
    ],
  }]
]],
```

- react 17.0.1 버전 패키지의 위치와, 의존성 목록을 기록해두고 있다.
- Yarn은 Node.js가 제공하는 require() 문의 동작을 덮어씀으로써 효율적으로 패키지를 찾을 수 있도록 한다.
  - 이 때문에 PnP API를 이용하여 의존성 관리를 하고 있을 때에는 node 명령어 대신 yarn node 명령어를 사용해야 한다.

```bash
$ yarn node
```

- Yarn으로 스크립트를 실행하기만 하면 자동으로 PnP로 의존성을 불러온다.

### ZipFS

- Yarn PnP 시스템에서 각 의존성은 Zip 아카이브로 관리된다.
- 압축 파일로 관리된다.
- zip으로 관리했을 때의 장점 :
  1. node_modules 디렉터리 구조를 관리할 필요가 없다. 때문에 설치가 빠르다.
  2. 용량을 아낄 수 있다.
  3. 파일수가 적어, 변경을 감지하거나 삭제가 빠르다.

<br>

## Plug’n’Play 도입 결과

### 1. 의존성을 검색할 때

- node_modules 폴더를 순회하지 않기 때문에 빨라졌다.
- require문이 빨라진다.

### 2. 의존성을 설치할 때

- ci 처럼 반복적으로 설치가 이루어지는 단계에서, 시간을 크게 절약할 수 있다.

### 3. 엄격한 의존성 관리

- 유령 의존성 현상을 막을 수 있다.

### 4. zero-install

- 의존성을 버전관리에 포함시키는 방법
- 새로 저장소를 복제하거나 브랜치를 바꾸었다고 해서 yarn install을 실행하지 않아도 된다.
- CI에서 의존성 설치하는 시간을 크게 절약할 수 있다.
