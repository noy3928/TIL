
# 9. 계층형 설계(2)


- 이 장의 결론 : 계층형 설계는 바로 아래 계층에 있는 함수로 현재 계층의 함수를 구현해 코드를 구성하는 기술이다. 어떤 코드를 테스트하는 것이 더 좋고, 변경하거나 재사용하기 쉬운 코드는 어떤 코드인지에 대해서는 계층 구조를 통해서 쉽게 확인할 수 있다.  
- 요점 정리 : 
	- 추상화 벽 패턴을 사용하면 세부적인 것을 완벽히 감출 수 있다. 때문에 더 높은 차원에서 생각할 수 있게 된다. 
	- 작은 인터페이스 패턴을 사용하면 완성된 인터페이스에 가깝게 계층을 만들 수 있다. 중요한 비즈니스 개념을 표현하는 인터페이스는 한번 잘 만들어 놓고 더 바뀌거나 늘어나지 않아야 한다. 
	- 편리한 계층 패턴을 이용하면 다른 패턴을 요구 사항에 맞게 사용할 수 있다. 패턴을 사용하다 보면 과한 추상화를 할 수 있다. 패턴들은 요구 사항에 맞게 적용해야한다. 
	- 호출 그래프 구조에서 규칙을 얻을 수 있다. 이 규칙으로 어떤 코드를 테스트 하는 것이 가장 좋은지, 유지보수나 재사용하기 좋은 코드는 어디에 있는 코드인지를 알 수 있다. 



## 패턴2 : 추상화 벽 

추상화벽은 여러 문제를 해결하는 데, 그 중 하나는 팀 간 책임을 명확하게 나누는 것이다. 

> 추상화 벽은 세부 구현을 감춘 함수로 이루어진 계층이다. 

추상화 벽에 함수들을 잘 넣어두면 대칭적인 효과를 얻을 수 있다. 이 함수를 사용하는 곳이나, 이 함수를 구현하는 곳이나 모두 독립적으로 작업을 할 수 있다는 것이다. 예를 들어서 구현하는 팀에서 장바구니의 데이터 구조를 바꾼다 할 지라도, 사용부의 사람들에게는 어떤 영향도 가지 않게 된다. 


### 추상화 벽이 있으면 구체적인 것을 신경쓰지 않아도 된다

> 추상화 벽은 어떤 것을 신경 쓰지 않아도 되지? 라는 말을 거창하게 표현한 개념이다. 

계층 구조에서 어떤 계층에 있는 함수들이 장바구니와 같이 공통된 개념을 신경 쓰지 않아도 된다면 그 계층을 추상화 벽이라고 할 수 있다. 추상화 벽은 필요하지 않은 것은 무시할 수 있도록 간접적인 단계를 만든다. 


### 추상화 벽은 언제 사용하면 좋을까? 

1. 쉽게 구현을 바꾸기 위해 : 구현에 대한 확신이 없는 경우에 추상화벽을 사용하면 구현을 간접적으로 사용할 수 있기 때문에 나중에 구현을 바꾸기 쉽다. 프로토타이핑과 같이 최선의 구현을 확신할 수 없는 작업에 유용하다. 
2. 코드를 읽고 쓰기 쉽게 만들기 위해 : 추상화 벽을 사용하면 세부적인 것을 신경 쓰지 않아도 된다. 적절한 것을 감추면 더 생산적인 코드를 만들 수 있다. 
3. 팀 간에 조율해야 할 것을 줄이기 위해 : 추상화 벽을 사용하면 각 팀에 관한 구체적인 내용을 서로 신경 쓰지 않아도 일할 수 있다. 게다가 더 빠르게 일할 수 있게 된다. 
4. 주어진 문제에 집중하기 위해 : 추상화 벽을 사용하면 해결하는 문제의 구체적인 부분을 무시할 수 있다. 그렇기 때문에 코드의 실수를 줄이고, 만들면서 지치지 않을 수 있다. 


### 추상화 벽의 효과 

- 추상화 벽으로 추상화 벽 아래에 있는 코드와 위에 있는 코드의 의존성을 없앨 수 있었다. 서로 신경 쓰지 않아도 되는 구체적인 것을 벽을 기준으로 나눠서 서로 의존하지 않게 한다. 
- 위 아래가 독립적이게 된다 : 추상화 벽과 그 아래에 있는 코드는 높은 수준의 계층에서 함수가 어떻게 사용되는지 몰라도 된다 
- 코드를 언제든지 쉽게 고칠 수 있다 : 추상화 벽을 사용하면 코드를 쉽게 고칠 수 있다. 하지만 이것만을 위해 추상화벽을 사용하는 것은 아니다. 추상화 벽은 팀 간에 커뮤니케이션 비용을 줄이고, 복잡한 코드를 명확하게 하기 위해 전략적으로 사용해야 한다. 



## 패턴3 : 작은 인터페이스 

작은 인터페이스 패턴은 새로운 코드를 추가할 위치에 관한 것입니다. 인터페이스를 최소화하면 하위 계층에 불필요한 기능이 쓸데없이 커지는 것을 막을 수 있다. 

특정 기능을 구현해야하는데, 해당 기능의 구현은 추상화 벽에 만드는 것이 좋을까, 추상화 벽 위에 만드는 것이 좋을까? 

### 가능하면 추상화 벽 위에 있는 계층에 구현하는 것이 좋다

- 여러 이유가 있겠지만, 추상화 벽 위에 있는 계층에 만드는 것이 더 직접 구현에 가깝다. (아마도 그 위에 있는 계층에 만들면 추상화벽에 있는 함수들을 사용할 수 있기 때문에 그런 것 같다. )

- 만약 추상화벽에 코드를 만들게 되면, 마케팅 팀에서 코드를 변경하고 싶을 때 개발 팀에 이야기해야 한다. 또 다른 문제도 있는데, 추상화 벽에 있는 함수는 개발팀과 마케팅팀 사이의 계약이라고 할 수 있다. 그런데 추상화 벽에 함수가 새롭게 생기면, 계약이 늘어나는 것과 같다. 더 많은 코드를 이해하고 더 많이 신경써야 한다. 

- 새로운 기능을 만들 때 하위 계층에 기능을 추가하거나 고치는 것보다 상위 계층에 만드는 것이 작은 인터페이스 패턴이라고 할 수 있다. 작은 인터페이스 패턴을 사용하면 하위 계층을 고치지 않고 상위 계층에서 문제를 해결할 수 있다. 

- 위치를 결정하는데 가장 중요한 요소는 장바구니에 관한 인터페이스를 깔끔하게 유지해야 한다는 점이다. 장바구니 인터페이스를 사용하면서 세부적인 것은 무시할 수 있었다. (액션의 전파를 고려해야한다.)


- 추상화 벽을 작게 만들어야 하는 이유 :
	- 추상화 벽에 코드가 많을수록 구현이 변경되었을 때 고쳐야 할 것이 많다. 
	- 추상화 벽에 있는 코드는 낮은 수준의 코드이기 때문에 더 많은 버그가 있을 수 있다. 
	- 낮은 수준의 코드는 이해하기가 더 어렵다. 
	- 추상화 벽에 코드가 많을수록 팀 간 조율해야 할 것도 많아진다. 
	- 추상화 벽에 인터페이스 많으면 알아야 할 것이 많아 사용하기 어렵다. 


## 패턴 4 : 편리한 계층 

편리한 계층 패턴은 언제 패턴을 적용하고 또 언제 멈춰야 하는지 실용적인 방법을 알려준다. 스스로 물어보자. 지금 편리한가? 만약 작업하는 코드가 편리하다고 느낀다면 설계는 조금 멈춰도 된다. 반복문은 감싸지 않고 그대로 두고 호출 화살표가 조금 길어지거나 계층이 다른 계층과 섞여도 그대로 두자. 

하지만 구체적인 것을 너무 많이 알아야 하거나, 코드가 지저분하다고 느껴진다면 다시 패턴을 적용하자. 어떤 코드도 이상적인 모습에 도달할 수 없다. 



## 그래프가 말해주는 것 

- 유지보수성 : 요구 사항이 바뀌었을 때 가장 쉽게 고칠 수 있는 코드는 어떤 코드인가? 
- 테스트성 : 어떤 것을 테스트 하는 것이 가장 중요한가? 
- 재사용성 : 어떤 함수가 재사용하기 좋은가? 


### 유지보수성 : 

- 가장 위에 있는 코드가 고치기 가장 쉽다. 
- 자주 바뀌는 요구사항 코드를 어디에 두면 좋은지 알 수 있다. 반대로 자주 바뀌면 안 되는 코드는 어디에 두는 것이 좋은지도 알 수 있다. 코드를 적절한 위치에 두면 유지보수 비용을 많이 줄일 수 있다. 
- 시간이 지나도 변하지 않는 코드는 가장 아래 계층에 있어야 한다. 
- 자주 바뀌는 것일 수록 위쪽에 있어야 한다. 

### 테스트성 : 

- 아래에 있는 코드는 테스트가 중요하다. 
- 제대로 만들었다면 가장 아래에 있는 코드보다 가장 위에 있는 코드가 더 자주 바뀔 것이다. 
- 테스트도 시간이 걸리는 일이다. 때문에 잘 바뀌지 않는 코드에 대해서 테스트를 작성하는 것이 훨씬 안정적이다. 
- 아래쪽에 있는 함수를 테스트하는 것이 위쪽에 있는 함수를 테스트하는 것보다 가치가 있다. 

### 재사용성 : 

- 아래에 있는 코드가 재사용하기 좋다. 
- 아래에 있는 코드를 재사용하면 시간과 비용을 줄일 수 있다. 
- 계층형 구조를 만들면 자연스럽게 재사용성이 좋아진다. 낮은 계층으로 함수를 추출하면 재사용할 가능성이 높아진다. 
- 낮은 수준의 단계로 함수를 빼내면 재사용성이 더 높아진다. 